
<!DOCTYPE html>  

<html lang="ar" dir="rtl">  
<head>  
    <meta charset="UTF-8">  
    <title>دفع قيمة الرحلة</title>  
    <link rel="stylesheet" href="payment.css">  
</head>  
<body>  

<div class="container">  

```
<h1>دفع قيمة الرحلة</h1>  

<label>إجمالي تكلفة الرحلة لكل راكب:</label>  
<input type="text" id="farePerPassenger" readonly />  

<h2>اختر وسيلة الدفع:</h2>  

<div class="payment-methods">  
    <label>  
        <input type="radio" name="pay" value="Card" onclick="togglePaymentFields()"> بطاقة  
    </label>  
    <label>  
        <input type="radio" name="pay" value="Wallet" onclick="togglePaymentFields()"> محفظة إلكترونية  
    </label>  
    <label>  
        <input type="radio" name="pay" value="Cash" onclick="togglePaymentFields()"> كاش  
    </label>  
</div>  

  
<div id="cardFields" style="display:none; margin-top: 15px;">  
    <label>رقم البطاقة:</label>  
    <input type="text" id="cardNumber" placeholder="xxxx xxxx xxxx xxxx">  

    <label>تاريخ الانتهاء:</label>  
    <input type="text" id="expiry" placeholder="MM/YY">  

    <label>رمز CVV:</label>  
    <input type="text" id="cvv" placeholder="123">  
</div>  

<button onclick="processPayment()">ادفع الآن</button>  

<h2 id="successMsg" style="display:none; color:green; margin-top:15px;">  
     تمت عملية الدفع بنجاح  
</h2>  
```

</div>  

<script>  
    
    let calculatedFare = 85;     
    document.getElementById("farePerPassenger").value = calculatedFare + " ريال";  

    function togglePaymentFields() {  
        let payment = document.querySelector("input[name='pay']:checked").value;  
        let cardSection = document.getElementById("cardFields");  

        if (payment === "Card") {  
            cardSection.style.display = "block";  

            let savedCard = localStorage.getItem("userCard");  
            if (savedCard) {  
                let cardData = JSON.parse(savedCard);  
                document.getElementById("cardNumber").value = cardData.number;  
                document.getElementById("expiry").value = cardData.expiry;  
                document.getElementById("cvv").value = cardData.cvv;  
            }  
        } else {  
            cardSection.style.display = "none";  
        }  
    }  

    function processPayment() {  
        let payment = document.querySelector("input[name='pay']:checked");  
        if (!payment) {  
            alert("الرجاء اختيار وسيلة الدفع");  
            return;  
        }  

        if (payment.value === "Card") {  
            let number = document.getElementById("cardNumber").value;  
            let expiry = document.getElementById("expiry").value;  
            let cvv = document.getElementById("cvv").value;  

            if (!number || !expiry || !cvv) {  
                alert("الرجاء إدخال بيانات البطاقة كاملة");  
                return;  
            }  

            // لحفظ البيانات للمرة القادمة  
            let cardData = { number, expiry, cvv };  
            localStorage.setItem("userCard", JSON.stringify(cardData));  
        }  

        document.getElementById("successMsg").style.display = "block";  
    }  



async function sendToBackend(paymentData) {
    try {
        console.log(' إرسال  :', paymentData);
        
        const response = await fetch('http://localhost:8083/api/payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(paymentData)
        });
        
        const result = await response.json();
        console.log(' ند:', result);
        
        const msg = document.getElementById("successMsg");
        msg.innerHTML = `${result.message}<br>رقم المرجع: ${result.transactionId}`;
        msg.style.display = "block";
        
    } catch (error) {
        console.error(' خطأ:', error);
        alert('خطأ في الاتصال  ');
    }
}

// عدل الدالة الأصلية processPayment
const originalProcessPayment = processPayment;
processPayment = async function() {
    // كودك الأصلي
    if (!document.querySelector("input[name='pay']:checked")) {
        alert("الرجاء اختيار وسيلة الدفع");
        return;
    }
    
    const paymentMethod = document.querySelector("input[name='pay']:checked").value;
    const paymentData = {
        amount: 85,
        method: paymentMethod,
        timestamp: new Date().toISOString()
    };
    
    if (paymentMethod === "Card") {
        const number = document.getElementById("cardNumber").value;
        const expiry = document.getElementById("expiry").value;
        const cvv = document.getElementById("cvv").value;
        
        if (!number || !expiry || !cvv) {
            alert("الرجاء إدخال بيانات البطاقة كاملة");
            return;
        }
        
        paymentData.cardNumber = number;
        paymentData.expiry = expiry;
        paymentData.cvv = cvv;
        
        localStorage.setItem("userCard", JSON.stringify({ number, expiry, cvv }));
    }
    
    await sendToBackend(paymentData);
};









</script>  

</body>  
</html>  


