<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <link rel="stylesheet" href="login.css">
</head>

<body>
  <div class="login-container">
    <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
    <form id="loginForm">

      <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input type="email" id="email" placeholder="example@sm.imamu.edu.sa" required>

      <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>

      <a href="forgotPassword.html" class="forgot-password">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>

      <button type="submit">Ø¯Ø®ÙˆÙ„</button>
      <p class="signup-link">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="signup.html">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p>
    </form>
  </div>

  <script>
    const loginForm = document.getElementById('loginForm');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email.endsWith('@sm.imamu.edu.sa')) {
        alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø£Ø¹Ø¶Ø§Ø¡ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©');
        return;
      }

      if (!password) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
      }

      try {
        console.log(' Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„...');

        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password }),
        });

        console.log(' Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯:', response.status, response.statusText);

        const responseText = await response.text();
        console.log(' Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¯:', responseText);

        if (!responseText) {
          throw new Error('Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø±Ø¬Ø¹ Ø±Ø¯Ø§Ù‹ ÙØ§Ø±ØºØ§Ù‹ - Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±');
        }

        let result;
        try {
          result = JSON.parse(responseText);
        } catch (jsonError) {
          console.error(' Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ JSON:', jsonError);
          throw new Error('Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…: ' + responseText);
        }

        console.log(' Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', result);

        if (result.success) {
          alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!');

          localStorage.setItem('currentUser', JSON.stringify(result.user));
          localStorage.setItem('userEmail', email);

          if (result.redirectUrl) {
            console.log('â¡ï¸ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰:', result.redirectUrl);
            window.location.href = result.redirectUrl;
          } else {
            if (result.user && result.user.role === 'driver') {
              window.location.href = 'driverUI.html';
            } else {
              window.location.href = 'passengerRides.html';
            }
          }
        } else {
          alert('Ø®Ø·Ø£: ' + result.message);
        }
      } catch (error) {
        console.error(' Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);

        console.log('ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', {
          email: email,
          time: new Date().toLocaleString(),
          error: error.message
        });
      }
    });

    document.addEventListener('DOMContentLoaded', function () {
      const savedEmail = localStorage.getItem('userEmail');
      if (savedEmail) {
        document.getElementById('email').value = savedEmail;
      }
    });
  </script>
</body>

</html>