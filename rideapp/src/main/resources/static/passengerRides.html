<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>ØµÙØ­Ø© Ø§Ù„Ø±Ø§ÙƒØ¨</title>
  <link rel="stylesheet" href="passenger.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="logo"></div>
    <ul class="menue">
      <li><a href="passengerRides.html"><i class="fas fa-home"></i><span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a></li>
      <li><a href="passengerRidesHistory.html"><i class="fas fa-history"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span></a></li>
      <li><a href="#"><i class="fas fa-bell"></i><span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></a></li>
      <li><a href="passengerEvents.html"><i class="fas fa-school"></i><span>Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</span></a></li>

    </ul>
  </div>
  <!-- Ø²Ø± Ø·ÙˆØ§Ø±Ø¦ Ø¹Ø§Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
  <div id="global-emergency" class="emergency-bar" onclick="openEmergencyPopupGlobal()">
    ğŸš¨ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦
  </div>
  <!-- MAIN CONTENT -->
  <main class="main-content">

    <div class="container">
      <div class="header">
        <button type="button" class="book-btn">Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†</button>
      </div>

      <!-- Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
      <div style="display: flex; align-items: center; gap: 15px;">
        <!-- Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± -->
        <button class="switch-role-btn" onclick="switchRole()">ØªØ¨Ø¯ÙŠÙ„ Ù„Ø³Ø§Ø¦Ù‚</button>

        <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
        <div class="profile-section">
          <button onclick="toggleProfileDropdown()" class="profile-btn">
            <i class="fas fa-user-circle"></i>
          </button>

          <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© -->
          <div id="profile-dropdown" class="dropdown-menu hidden">
            <ul>
              <li><a href="#" onclick="showRatingPage()"><i class="fas fa-star"></i><span>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span></a></li>
              <li><a href="passengerSetting.html"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a></li>
              <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
    <div id="rating-page" class="full-page hidden">
      <div class="container-form">
        <div class="form-box">
          <div class="page-header">
            <button onclick="closePage()" class="back-btn"><i class="fas fa-arrow-right"></i></button>
            <h2>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
          </div>

          <div class="rating-history">
            <div class="rating-summary">
              <div class="average-rating">
                <span class="rating-number">0.0</span>
                <div class="stars-display">
                  <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                  <i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <span class="total-reviews">(0 ØªÙ‚ÙŠÙŠÙ…)</span>
                <p>Ø³ØªØ¸Ù‡Ø± ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙƒ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
              </div>
            </div>

            <div class="reviews-list">
              <div class="no-reviews">
                <i class="fas fa-star"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>
                <span>Ø³ØªØ¸Ù‡Ø± ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø±ÙƒØ§Ø¨ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>



    <div class="logout-overlay hidden" id="driverCheckModal">
      <div class="logout-modal">
        <div class="logout-content">
          <i class="fas fa-id-card logout-icon"></i>
          <h3>Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚</h3>
          <p id="driverCheckMessage">Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚ØŸ</p>
          <div class="logout-buttons">
            <button id="confirmYesBtn" class="confirm-logout-btn">Ù†Ø¹Ù…</button>
            <button onclick="closeDriverCheckModal()" class="cancel-logout-btn">Ù„Ø§</button>
          </div>
        </div>
      </div>
    </div>


    <div class="logout-overlay hidden" id="confirmedDriverModal">
      <div class="logout-modal">
        <div class="logout-content">
          <i class="fas fa-car logout-icon"></i>
          <h3>Ø³Ø§Ø¦Ù‚ Ù…ÙˆØ«Ù‚</h3>
          <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ØŸ</p>
          <div class="logout-buttons">
            <button onclick="goToDriverUI()" class="confirm-logout-btn">Ù†Ø¹Ù…</button>
            <button onclick="closeConfirmedDriverModal()" class="cancel-logout-btn">Ù„Ø§</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
    <div class="logout-overlay hidden" id="pendingDriverModal">
      <div class="logout-modal">
        <div class="logout-content">
          <i class="fas fa-clock logout-icon"></i>
          <h3>Ø·Ù„Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</h3>
          <p> ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ ÙƒØ³Ø§Ø¦Ù‚ ÙˆÙŠØ¬Ø±ÙŠ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.<br>Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.</p>
          <div class="logout-buttons">
            <button onclick="closePendingDriverModal()" class="confirm-logout-btn">Ù…ÙˆØ§ÙÙ‚</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚ -->
    <div class="upload-modal hidden" id="uploadModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Ø·Ù„Ø¨ Ø£Ù† ØªØµØ¨Ø­ Ø³Ø§Ø¦Ù‚Ø§Ù‹</h2>
          <button class="close-btn" onclick="closeUploadModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="requirements">
          <h4><i class="fas fa-info-circle"></i> Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h4>
          <ul>
            <li>Ø±Ø®ØµØ© Ù‚ÙŠØ§Ø¯Ø© Ø³Ø§Ø±ÙŠØ©</li>
            <li>JPG / PNG / PDF</li>
          </ul>
        </div>

        <form id="uploadForm">
          <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© -->
          <div class="form-section">
            <h4>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø±ÙƒØ¨Ø©</h4>

            <div class="form-group">
              <label>Ø±Ù‚Ù… Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© *</label>
              <input type="text" id="licenseNumber" required>
            </div>

            <div class="form-group">
              <label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© *</label>
              <input type="text" id="carModel" required>
            </div>

            <div class="form-group">
              <label>Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø© *</label>
              <input type="text" id="carColor" required>
            </div>

            <div class="form-group">
              <label>Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© *</label>
              <input type="text" id="plateNumber" required>
            </div>

            <div class="form-group">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© *</label>
              <input type="number" id="availableSeats" min="1" max="10" required>
            </div>
          </div>

          <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª -->
          <div class="upload-section">
            <label>Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (ØµÙˆØ±Ø©) *</label>
            <input type="file" id="licenseUpload" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>
          <div class="upload-section">
            <label>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (ØµÙˆØ±Ø©) *</label>
            <input type="file" id="licenseUpload" accept=".jpg,.jpeg,.png,.pdf" required>
          </div>

          <button type="submit" class="submit-btn">
            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
          </button>
        </form>

      </div>

    </div>
    <div id="emergencyPopup" class="logout-overlay hidden">
      <div class="logout-modal" style="max-width:400px;">
        <div class="logout-content">
          <i class="fas fa-exclamation-triangle logout-icon" style="color:#d90429;"></i>
          <h3>Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦</h3>
          <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ØŸ</p>

          <div class="logout-buttons">
            <button id="confirmEmergency" class="confirm-logout-btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
            <button onclick="closeEmergencyPopup()" class="cancel-logout-btn">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>
    </div>

    <section id="myBookings" class="trips-section">
      <div class="trips-grid" id="passenger-bookings"></div>
    </section>


  </main>

  <script>
    function toggleProfileDropdown() {
      document.getElementById('profile-dropdown').classList.toggle('hidden');
    }

    document.addEventListener('click', function (event) {
      const profile = document.querySelector('.profile-section');
      if (!profile.contains(event.target)) {
        document.getElementById('profile-dropdown').classList.add('hidden');
      }
    });

    function showRatingPage() {
      document.getElementById('rating-page').classList.remove('hidden');
    }

    function closePage() {
      document.querySelectorAll('.full-page').forEach(p => p.classList.add('hidden'));
    }

    function logout() {
      document.getElementById('profile-dropdown').classList.add('hidden');
      const overlay = document.createElement('div');
      overlay.className = 'logout-overlay';
      overlay.id = 'logout-confirmation';

      overlay.innerHTML = `
      <div class="logout-modal">
        <div class="logout-content">
          <i class="fas fa-sign-out-alt logout-icon"></i>
          <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
          <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
          <div class="logout-buttons">
            <button onclick="confirmLogout()" class="confirm-logout-btn">Ù†Ø¹Ù…</button>
            <button onclick="cancelLogout()" class="cancel-logout-btn">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>`;

      document.body.appendChild(overlay);
    }

    function confirmLogout() {
      localStorage.removeItem("currentUser");
      localStorage.removeItem("userEmail");
      localStorage.removeItem("resetPasswordMode");

      const overlay = document.getElementById('logout-confirmation');
      overlay.innerHTML = `
      <div class="logout-modal">
        <div class="logout-content success">
          <i class="fas fa-check-circle success-icon"></i>
          <h3>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
          <button onclick="closeLogoutSuccess()" class="success-btn">Ù…ÙˆØ§ÙÙ‚</button>
        </div>
      </div>`;
    }

    function cancelLogout() {
      const overlay = document.getElementById('logout-confirmation');
      if (overlay) overlay.remove();
    }

    function closeLogoutSuccess() {
      window.location.href = "login.html";
    }

    function showPendingDriverModal() {
      document.getElementById('pendingDriverModal').classList.remove('hidden');
    }

    function closePendingDriverModal() {
      document.getElementById('pendingDriverModal').classList.add('hidden');
    }

    async function switchRole() {
      const email = localStorage.getItem("userEmail");

      if (!email) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        window.location.href = "login.html";
        return;
      }

      try {
        console.log(" Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù€:", email);

        const response = await fetch(`/api/switch/checkDriverStatus?email=${encodeURIComponent(email)}`);

        if (!response.ok) {
          throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚');
        }

        const result = await response.json();
        console.log(" Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚:", result);

        if (result.status === "verified_driver") {
          console.log(" Ø³Ø§Ø¦Ù‚ Ù…ÙˆØ«Ù‚");
          showConfirmedDriverModal();

        } else if (result.status === "pending_driver") {
          console.log("Ø·Ù„Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©");
          showPendingDriverModal();
        } else if (result.status === "not_driver") {
          console.log(" ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙƒØ³Ø§Ø¦Ù‚");
          showDriverCheckModal(
            "Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ³Ø§Ø¦Ù‚ØŸ",
            () => openDriverRegistrationForm()
          );

        } else if (result.status === "rejected_driver") {
          alert("Ø¹Ø°Ø±Ù‹Ø§ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ ÙƒØ³Ø§Ø¦Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ù‹Ø§.");
        }
        else {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙƒ ÙƒØ³Ø§Ø¦Ù‚.");
        }


      } catch (error) {
        console.error('Error in switchRole:', error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      }
    }



    async function checkDriverStatus(email) {
      try {
        const response = await fetch(`/api/switch/checkDriverStatus?email=${encodeURIComponent(email)}`);

        if (!response.ok) {
          throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚');
        }

        const result = await response.json();
        return result.status;

      } catch (error) {
        console.error('Error checking driver status:', error);
        return "no_driver_data";
      }
    }

    async function registerDriver(driverData) {
      try {
        const response = await fetch('/api/switch/registerDriver', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(driverData)
        });

        if (!response.ok) throw new Error('Registration failed');
        return await response.json();
      } catch (error) {
        console.error('Error registering driver:', error);
        return { success: false };
      }
    }

    function showDriverCheckModal(message, onConfirm) {
      const modal = document.getElementById('driverCheckModal');
      const messageElement = document.getElementById('driverCheckMessage');
      const confirmBtn = document.getElementById('confirmYesBtn');

      messageElement.textContent = message;
      confirmBtn.onclick = onConfirm;

      modal.classList.remove('hidden');
    }

    function closeDriverCheckModal() {
      document.getElementById('driverCheckModal').classList.add('hidden');
    }

    function openDriverRegistrationForm() {
      closeDriverCheckModal();
      document.getElementById("uploadModal").classList.remove("hidden");
    }

    function closeUploadModal() {
      document.getElementById("uploadModal").classList.add("hidden");
    }

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const email = localStorage.getItem("userEmail");
      if (!email) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }

      const driverData = {
        email: email,
        licenseNumber: document.getElementById('licenseNumber').value,
        carModel: document.getElementById('carModel').value,
        carColor: document.getElementById('carColor').value,
        plateNumber: document.getElementById('plateNumber').value,
        availableSeats: parseInt(document.getElementById('availableSeats').value),
        licenseFile: document.getElementById('licenseUpload').files[0]?.name || '' // Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø·
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      if (!validateDriverData(driverData)) {
        return;
      }

      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ³Ø¬ÙŠÙ„
      const result = await registerDriver(driverData);

      if (result.success) {
        //  Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­ - Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
        alert("ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù†ØªØ¸Ø± 48 Ø³Ø§Ø¹Ø© ");
        window.location.href = "passengerRides.html";
      } else {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + (result.message || "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."));
      }
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function validateDriverData(data) {
      if (!data.licenseNumber.trim()) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©");
        return false;
      }

      if (!data.carModel.trim()) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©");
        return false;
      }

      if (!data.carColor.trim()) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙˆÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©");
        return false;
      }

      if (!data.plateNumber.trim()) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©");
        return false;
      }

      if (!data.availableSeats || data.availableSeats < 1) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ ØµØ­ÙŠØ­");
        return false;
      }

      const licenseFile = document.getElementById('licenseUpload').files[0];
      if (!licenseFile) {
        alert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©");
        return false;
      }

      return true;
    }
    function showConfirmedDriverModal() {
      document.getElementById('confirmedDriverModal').classList.remove('hidden');
    }

    function closeConfirmedDriverModal() {
      document.getElementById('confirmedDriverModal').classList.add('hidden');
    }

    function goToDriverUI() {
      window.location.href = "driverUI.html";
    }

    //  Ø²Ø± "Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†" ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø­Ø¬Ø²
    document.querySelector('.book-btn').addEventListener('click', function () {
      window.location.href = "bookingPage.html";
    });
    window.addEventListener("DOMContentLoaded", () => {
      loadPassengerBookings();
    });

    function loadPassengerBookings() {
      const passengerEmail = localStorage.getItem("userEmail");

      fetch(`http://localhost:8083/api/passenger/my-bookings?passengerEmail=${encodeURIComponent(passengerEmail)}`)
        .then(res => res.json())
        .then(bookings => {

          const container = document.getElementById("passenger-bookings");
          container.innerHTML = "";

          if (!Array.isArray(bookings) || bookings.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª</p>`;
            return;
          }

          bookings.forEach(booking => {

            let statusColor = "";
            let statusText = "";

            if (booking.status === "pending") {
              statusColor = "pending";
              statusText = "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
            } else if (booking.status === "accepted") {
              statusColor = "accepted";
              statusText = "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„";
            } else if (booking.status === "rejected") {
              statusColor = "rejected";
              statusText = "ØªÙ… Ø§Ù„Ø±ÙØ¶";
            }

            const card = `
          </div>
</div>





</article>


                <article class="trip-card">

                    <div>
                        <div class="card-header">
                            <h3>Ø±Ø­Ù„ØªÙƒ</h3>
                            <div class="chat-icon"><i class="fas fa-comment"></i></div>
                        </div>

                        <div class="trip-info">

                            <div class="location-row">
                                <div class="location-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <div>
                                        <span class="label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</span>
                                        <span class="value">${booking.ride.currentLocation}</span>
                                    </div>
                                </div>

                                <div class="location-item">
                                    <i class="fas fa-flag"></i>
                                    <div>
                                        <span class="label">Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„:</span>
                                        <span class="value">${booking.ride.destination}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="details-row">
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <div>
                                        <span class="label">Ø§Ù„ÙŠÙˆÙ…:</span>
                                        <span class="value">${booking.ride.date}</span>
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <div>
                                        <span class="label">Ø§Ù„ÙˆÙ‚Øª:</span>
                                        <span class="value">${booking.ride.time}</span>
                                    </div>
                                </div>

                                <div class="detail-item">
                                    <i class="fas fa-users"></i>
                                    <div>
                                        <span class="label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                                        <span class="value ${statusColor}">${statusText}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="driver-section">
                        <div class="driver-info">
                            <div class="driver-avatar"><i class="fas fa-user"></i></div>
                            <div class="driver-details">
<div class="driver-name">
   ${booking.ride.driverName || booking.ride.driver?.name || booking.ride.driverEmail}
</div>                                <div class="driver-rating">
                                    <div class="stars">â˜… â˜… â˜… â˜… â˜…</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </article>
                `;

            container.innerHTML += card;
          });
        });
    }

    function getPassengerGender() {
      const email = localStorage.getItem("userEmail");

      return fetch(`http://localhost:8083/api/user/gender?email=${email}`)
        .then(res => res.text())
        .then(g => g.trim().toLowerCase());
    }

    function loadAvailableRides() {
      const passengerEmail = localStorage.getItem("userEmail");

      fetch(`http://localhost:8083/api/rides/available?passengerEmail=${passengerEmail}`)
        .then(res => res.json())
        .then(async rides => {

          const container = document.getElementById("rides-container");
          container.innerHTML = "";

          if (rides.length === 0) {
            container.innerHTML = `<p style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø©</p>`;
            return;
          }

          rides.forEach(ride => {

            let seatLabel = ride.seatsAvailable === 0
              ? `<span style="color:red;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø©</span>`
              : `${ride.seatsAvailable} / ${ride.totalSeats}`;

            const card = `
                <div class="ride-card">
                    <p><b>Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</b> ${ride.currentLocation}</p>
                    <p><b>Ø§Ù„ÙˆØ¬Ù‡Ø©:</b> ${ride.destination}</p>
                    <p><b>Ø§Ù„ÙŠÙˆÙ…:</b> ${ride.date}</p>
                    <p><b>Ø§Ù„ÙˆÙ‚Øª:</b> ${ride.time}</p>
                    <p><b>Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</b> ${seatLabel}</p>

                    <button class="book-btn"
                        data-ride-id="${ride.rideId}"
                        data-gender-pref="${ride.genderPreference}">
                        Ø­Ø¬Ø²
                    </button>
                </div>
                `;

            container.innerHTML += card;
          });

          // =============  Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø¯Ø« Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª =============
          document.querySelectorAll(".book-btn").forEach(btn => {
            btn.addEventListener("click", async () => {

              const rideId = btn.getAttribute("data-ride-id");
              const rideGenderPref = btn.getAttribute("data-gender-pref").toLowerCase();

              const passengerGender = await getPassengerGender();

              // ===== Ø´Ø±ÙˆØ· Ø§Ù„Ø¬Ù†Ø¯Ø± =====
              if (rideGenderPref === "male" && passengerGender !== "male") {
                alert("Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø±Ø¬Ø§Ù„ ÙÙ‚Ø·.");
                return;
              }

              if (rideGenderPref === "female" && passengerGender !== "female") {
                alert("Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù†Ø³Ø§Ø¡ ÙÙ‚Ø·.");
                return;
              }

              // ===== Ø¥Ø°Ø§ ÙƒÙ„Ù‡ ØªÙ…Ø§Ù…ØŒ Ù†Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² =====
              bookRide(rideId);
            });
          });
        });
    }

    function bookRide(rideId) {
      const passengerEmail = localStorage.getItem("userEmail");

      fetch(`http://localhost:8083/api/bookings/request?rideId=${rideId}&passengerEmail=${passengerEmail}`, {
        method: "POST"
      })
        .then(res => {
          if (res.ok) {
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø²!");
            loadAvailableRides();
          } else {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù‚Ø§Ø¹Ø¯ Ù…ØªØ§Ø­Ø©!");
          }
        });
    }

    let selectedRideId = null;

    function openEmergencyPopup(rideId) {
      selectedRideId = rideId;
      document.getElementById("emergencyPopup").classList.remove("hidden");
    }

    function closeEmergencyPopup() {
      document.getElementById("emergencyPopup").classList.add("hidden");
      selectedRideId = null;
    }
    function openEmergencyPopupGlobal() {
      document.getElementById("emergencyPopup").classList.remove("hidden");
    }


    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("confirmEmergency");

      if (btn) {
        btn.onclick = () => {
          const userEmail = localStorage.getItem("userEmail");

          fetch(`/api/safety/trigger?userId=${userEmail}&message=Emergency`, {
            method: "POST"
          })

            .then(res => {
              if (res.ok) {
                alert(" ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¨Ù†Ø¬Ø§Ø­!");
              } else {
                alert(" Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº");
              }

              closeEmergencyPopup();
            });
        };
      }
    });


  </script>

</body>

</html>