<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</title>
  <link rel="stylesheet" href="driver.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>

  <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
  <div class="sidebar">
    <div class="logo"></div>
    <ul class="menue">
      <li><a href="driverUI.html"><i class="fas fa-home"></i><span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a></li>
      <li><a href="driverRiedsHistory.html"><i class="fas fa-history"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span></a></li>
      <li><a href="#"><i class="fas fa-bell"></i><span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></a></li>
      <li><a href="driverEvents.html"><i class="fas fa-school"></i><span>Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</span></a></li>
    </ul>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="main-content">
    <div class="top-bar">
      <button type="button" class="create-btn" onclick="window.location.href='creatRide.html'">
        Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø­Ù„Ø©
      </button>

      <div style="display: flex; align-items: center; gap: 15px;">
        <!-- Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¯ÙˆØ§Ø± -->
        <button class="switch-role-btn" onclick="showSwitchRoleConfirmation()">ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ø§ÙƒØ¨</button>

        <!-- Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
        <div class="profile-section">
          <button onclick="toggleProfileDropdown()" class="profile-btn">
            <i class="fas fa-user-circle"></i>
          </button>

          <div id="profile-dropdown" class="dropdown-menu hidden">
            <ul>
              <li><a href="#" onclick="showRatingPage()"><i class="fas fa-star"></i><span>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span></a></li>
              <li><a href="driverSetting.html"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a></li>
              <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    
<div class="content-area">

  <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  <div class="stats-card">

    <div class="stat-box">
        <p>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
        <span id="new-requests">0</span>
    </div>

    <div class="stat-box">
        <p>Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</p>
        <span id="accepted">0</span>
    </div>

    <div class="stat-box">
        <p>Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</p>
        <span id="rejected">0</span>
    </div>


  </div>
<!-- Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© + Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div class="ride-details-card" 
     style="background:white; padding:20px; border-radius:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-top:40px;">

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø­Ù„Ø© -->
    <h2 style="font-size:22px; font-weight:bold; margin-bottom:15px;">Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</h2>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© -->
    <div style="line-height: 2; margin-bottom:20px; text-align:right;">
        <p><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø­Ù„Ø©:</b> <span id="ride-date">â€”</span></p>
        <p><b>ÙˆÙ‚Øª Ø§Ù„Ø±Ø­Ù„Ø©:</b> <span id="ride-time">â€”</span></p>
        <p><b>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</b> <span id="ride-start">â€”</span></p>
        <p><b>Ø§Ù„ÙˆØ¬Ù‡Ø©:</b> <span id="ride-destination">â€”</span></p>
        <p><b>Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</b> <span id="ride-seats">â€”</span></p>
    </div>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <h3 style="font-size:18px; font-weight:bold; margin-bottom:15px;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬Ø²</h3>

    <!-- Ù‡Ù†Ø§ Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„ØµØºÙŠØ±Ø© -->
    <div id="booking-requests-container" 
         style="display:grid; gap:15px; max-height:350px; overflow-y:auto;">
    </div>

</div>







      </div>

      <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø§Øª -->
      <div class="trips-container" id="trips-container">
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª -->
    <div id="rating-page" class="full-page hidden">
      <div class="container-form">
        <div class="form-box">
          <div class="page-header">
            <button onclick="closePage()" class="back-btn"><i class="fas fa-arrow-right"></i></button>
            <h2>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
          </div>

          <div class="rating-history">
            <div class="rating-summary">
              <div class="average-rating">
                <span class="rating-number">0.0</span>
                <div class="stars-display">
                  <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                  <i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <span class="total-reviews">(0 ØªÙ‚ÙŠÙŠÙ…)</span>
                <p>Ø³ØªØ¸Ù‡Ø± ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙƒ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
              </div>
            </div>

            <div class="reviews-list">
              <div class="no-reviews">
                <i class="fas fa-star-o"></i>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>
                <span>Ø³ØªØ¸Ù‡Ø± ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø±ÙƒØ§Ø¨ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø¨ÙˆØ¨ Ø£Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div id="popup" class="full-page hidden">
      <div class="form-box">
        <h2 id="popup-name"></h2>
        <p>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: <span id="popup-start"></span></p>
        <p>Ø§Ù„ÙˆØ¬Ù‡Ø©: <span id="popup-end"></span></p>
        <p>Ø§Ù„ÙˆÙ‚Øª: <span id="popup-time"></span></p>
        <button class="update-btn" onclick="closePopup()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ -->
    <div id="switch-role-confirmation" class="logout-overlay hidden">
      <div class="logout-modal">
        <div class="logout-content">
          <i class="fas fa-sync-alt logout-icon"></i>
          <h3>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±</h3>
          <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ØŸ</p>
          <div class="logout-buttons">
            <button onclick="confirmSwitchRole()" class="confirm-logout-btn">Ù†Ø¹Ù…</button>
            <button onclick="cancelSwitchRole()" class="cancel-logout-btn">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      </div>
    </div>


    <script>
      // ==============================
      // â¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
      // ==============================
      function toggleProfileDropdown() {
        document.getElementById('profile-dropdown').classList.toggle('hidden');
      }

      function showRatingPage() {
        document.getElementById('profile-dropdown').classList.add('hidden');
        document.getElementById('rating-page').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      }

      function closePage() {
        document.querySelectorAll('.full-page').forEach(p => p.classList.add('hidden'));
        document.body.style.overflow = 'auto';
      }

      document.addEventListener("click", function (event) {
        const profileArea = document.querySelector(".profile-section");
        const dropdown = document.getElementById("profile-dropdown");
        if (!profileArea.contains(event.target)) {
          dropdown.classList.add("hidden");
        }
      });

      // ==============================
      // â· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
      // ==============================
      function logout() {
        document.getElementById("profile-dropdown").classList.add("hidden");
        const overlay = document.createElement("div");
        overlay.className = "logout-overlay";
        overlay.innerHTML = `
        <div class="logout-modal">
          <div class="logout-content">
            <i class="fas fa-sign-out-alt logout-icon"></i>
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
            <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
            <div class="logout-buttons">
              <button onclick="confirmLogout()" class="confirm-logout-btn">Ù†Ø¹Ù…</button>
              <button onclick="cancelLogout()" class="cancel-logout-btn">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>
        </div>`;
        document.body.appendChild(overlay);
      }

      function confirmLogout() {
        localStorage.clear();
        const overlay = document.querySelector(".logout-overlay");
        overlay.innerHTML = `
        <div class="logout-modal">
          <div class="logout-content success">
            <i class="fas fa-check-circle success-icon"></i>
            <h3>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
            <button onclick="closeLogoutSuccess()" class="success-btn">Ù…ÙˆØ§ÙÙ‚</button>
          </div>
        </div>`;
      }

      function cancelLogout() {
        document.querySelector(".logout-overlay").remove();
      }

      function closeLogoutSuccess() {
        window.location.href = "login.html";
      }

      // ==============================
      // â¸ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø³Ø§Ø¦Ù‚ / Ø±Ø§ÙƒØ¨
      // ==============================
      function showSwitchRoleConfirmation() {
        document.getElementById("switch-role-confirmation").classList.remove("hidden");
        document.body.style.overflow = "hidden";
      }

      function confirmSwitchRole() {
        window.location.href = "passengerRides.html";
      }

      function cancelSwitchRole() {
        document.getElementById("switch-role-confirmation").classList.add("hidden");
        document.body.style.overflow = "auto";
      }

      // ==============================
      // â¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      // ==============================
      function updateStats(pending, accepted, rejected) {
        document.getElementById("new-requests").textContent = pending;
        document.getElementById("accepted").textContent = accepted;
        document.getElementById("rejected").textContent = rejected;
      }

      function initStats() {
        const accepted = parseInt(localStorage.getItem("driverAcceptedCount")) || 0;
        const rejected = parseInt(localStorage.getItem("driverRejectedCount")) || 0;
        updateStats(0, accepted, rejected);
      }

      // ==============================
      // âº Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬Ø² Ù„Ù„Ø³Ø§Ø¦Ù‚ - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§
      // ==============================
   function loadBookingRequests() {
    const driverEmail = localStorage.getItem("userEmail");

    fetch(`http://localhost:8083/api/bookings/driver-requests?driverEmail=${driverEmail}`)
        .then(res => res.json())
        .then(requests => {

            const container = document.getElementById("booking-requests-container");
            container.innerHTML = "";

            const pendingCount = requests.length;
            const accepted = parseInt(localStorage.getItem("driverAcceptedCount")) || 0;
            const rejected = parseInt(localStorage.getItem("driverRejectedCount")) || 0;

            updateStats(pendingCount, accepted, rejected);

            // -------------------------------------------
            //  ğŸ”¥ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙƒØ§Ø±Ø¯ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
            // -------------------------------------------
            if (requests.length > 0) {
                const ride = requests[0].ride;

                document.getElementById("ride-date").textContent = ride.date;
                document.getElementById("ride-time").textContent = ride.time;
                document.getElementById("ride-start").textContent = ride.currentLocation;
                document.getElementById("ride-destination").textContent = ride.destination;
                document.getElementById("ride-seats").textContent =
                    `${ride.seatsAvailable} / ${ride.totalSeats}
`;
            } else {
                document.getElementById("ride-date").textContent = "â€”";
                document.getElementById("ride-time").textContent = "â€”";
                document.getElementById("ride-start").textContent = "â€”";
                document.getElementById("ride-destination").textContent = "â€”";
                document.getElementById("ride-seats").textContent = "â€”";
            }

            // -------------------------------------------
            //  ğŸ”¥ ÙƒØ±ÙˆØª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Ø¯
            // -------------------------------------------
            if (pendingCount === 0) {
                container.innerHTML = `<p style="text-align:center; color:#777; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯Ø©</p>`;
                return;
            }

            requests.forEach(request => {

                const card = document.createElement("div");
                card.className = "booking-request-card";

                card.innerHTML = `
<div class="request-info" style="width: 100%;">
<h3 style="font-size:20px;color:#333;">Ø·Ù„Ø¨ Ù…Ù†: ${request.passenger.name}</h3>



    <p><b>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</b> ${request.ride.currentLocation}</p>

</div>

<div class="request-actions">
    <button class="accept-btn" onclick="respondToBooking(${request.bookingId}, 'accepted')">Ù‚Ø¨ÙˆÙ„</button>
    <button class="reject-btn" onclick="respondToBooking(${request.bookingId}, 'rejected')">Ø±ÙØ¶</button>
</div>
                `;

                container.appendChild(card);
            });
        })
        .catch(err => {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", err);
            initStats();
        });
}






      // ==============================
      // â» Ø±Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ (Ù‚Ø¨ÙˆÙ„/Ø±ÙØ¶)
      // ==============================
      function respondToBooking(bookingId, status) {
        fetch(`http://localhost:8083/api/bookings/respond?bookingId=${bookingId}&status=${status}`, {
          method: "POST"
        })
        .then(res => {
          if (!res.ok) {
            alert("ÙØ´Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨");
            return;
          }
          alert(status === "accepted" ? "âœ” ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø­Ø¬Ø²" : "âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­Ø¬Ø²");
          
          let accepted = parseInt(localStorage.getItem("driverAcceptedCount")) || 0;
          let rejected = parseInt(localStorage.getItem("driverRejectedCount")) || 0;
          
          if (status === "accepted") {
            localStorage.setItem("driverAcceptedCount", ++accepted);
          } else {
            localStorage.setItem("driverRejectedCount", ++rejected);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
loadBookingRequests();

          }
          
          loadBookingRequests();
          initStats();
        })
        .catch(err => {
          console.error("Ø®Ø·Ø£:", err);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¯");
        });
      }
      
     



      // ==============================
      // â¼ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      // ==============================
      document.addEventListener("DOMContentLoaded", () => {
    initStats();
    loadBookingRequests();
});

    </script>

    <style>
      .booking-request-card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 15px;
        background: white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .request-info h4 {
        margin: 0 0 10px 0;
        color: #333;
      }
      
      .request-info p {
        margin: 5px 0;
        color: #666;
      }
      
      .request-actions {
        display: flex;
        gap: 10px;
      }
      
      .accept-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
      }
      
      .reject-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
      }
      
      .accept-btn:hover {
        background: #218838;
      }
      
      .reject-btn:hover {
        background: #c82333;
      }
    </style>
  </div>
</body>
</html>