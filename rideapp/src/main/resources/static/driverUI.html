<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>واجهة السائق</title>
  <link rel="stylesheet" href="driver.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>

  <!-- القائمة الجانبية -->
  <div class="sidebar">
    <div class="logo"></div>
    <ul class="menue">
      <li><a href="driverUI.html"><i class="fas fa-home"></i><span>الصفحة الرئيسية</span></a></li>
      <li><a href="driverRidesHistory.html"><i class="fas fa-history"></i><span>سجل الرحلات</span></a></li>
      <li><a href="#"><i class="fas fa-bell"></i><span>الإشعارات</span></a></li>
      <li><a href="driverEvents.html"><i class="fas fa-school"></i><span>أنشطة الجامعة</span></a></li>
    </ul>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="main-content">
    <div class="top-bar">
      <button type="button" class="create-btn" onclick="window.location.href='creatRide.html'">
        إنشاء رحلة
      </button>

      <div style="display: flex; align-items: center; gap: 15px;">
        <!-- زر التبديل بين الأدوار -->
        <button class="switch-role-btn" onclick="showSwitchRoleConfirmation()">تبديل إلى راكب</button>

        <!-- الملف الشخصي -->
        <div class="profile-section">
          <button onclick="toggleProfileDropdown()" class="profile-btn">
            <i class="fas fa-user-circle"></i>
          </button>

          <div id="profile-dropdown" class="dropdown-menu hidden">
            <ul>
              <li><a href="#" onclick="showRatingPage()"><i class="fas fa-star"></i><span>سجل التقييمات</span></a></li>
              <li><a href="driverSetting.html"><i class="fas fa-cog"></i><span>الإعدادات</span></a></li>
              <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>


    <div class="content-area">

      <!-- الإحصائيات -->
      <div class="stats-card">

        <div class="stat-box">
          <p>الطلبات الجديدة</p>
          <span id="new-requests">0</span>
        </div>

        <div class="stat-box">
          <p>المقبولة</p>
          <span id="accepted">0</span>
        </div>

        <div class="stat-box">
          <p>المرفوضة</p>
          <span id="rejected">0</span>
        </div>

      </div>

      <div id="driver-rides-area" class="rides-grid"></div>

    </div>



    <!-- حاوية الرحلات -->
    <div class="trips-container" id="trips-container">
    </div>
  </div>

  <!-- صفحة التقييمات -->
  <div id="rating-page" class="full-page hidden">
    <div class="container-form">
      <div class="form-box">
        <div class="page-header">
          <button onclick="closePage()" class="back-btn"><i class="fas fa-arrow-right"></i></button>
          <h2>سجل التقييمات</h2>
        </div>

        <div class="rating-history">
          <div class="rating-summary">
            <div class="average-rating">
              <span class="rating-number">0.0</span>
              <div class="stars-display">
                <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                <i class="fas fa-star"></i><i class="fas fa-star"></i>
              </div>
              <span class="total-reviews">(0 تقييم)</span>
              <p>ستظهر تقييماتك هنا بعد إكمال الرحلات</p>
            </div>
          </div>

          <div class="reviews-list">
            <div class="no-reviews">
              <i class="fas fa-star-o"></i>
              <p>لا توجد تقييمات بعد</p>
              <span>ستظهر تقييمات الركاب هنا بعد إكمال الرحلات</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- بوب أب معلومات -->
  <div id="popup" class="full-page hidden">
    <div class="form-box">
      <h2 id="popup-name"></h2>
      <p>موقع الانطلاق: <span id="popup-start"></span></p>
      <p>الوجهة: <span id="popup-end"></span></p>
      <p>الوقت: <span id="popup-time"></span></p>
      <button class="update-btn" onclick="closePopup()">إغلاق</button>
    </div>
  </div>

  <!-- تأكيد التبديل -->
  <div id="switch-role-confirmation" class="logout-overlay hidden">
    <div class="logout-modal">
      <div class="logout-content">
        <i class="fas fa-sync-alt logout-icon"></i>
        <h3>تبديل الدور</h3>
        <p>هل أنت متأكد من التبديل إلى وضع الراكب؟</p>
        <div class="logout-buttons">
          <button onclick="confirmSwitchRole()" class="confirm-logout-btn">نعم</button>
          <button onclick="cancelSwitchRole()" class="cancel-logout-btn">إلغاء</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    function toggleProfileDropdown() {
      document.getElementById('profile-dropdown').classList.toggle('hidden');
    }

    function showRatingPage() {
      document.getElementById('profile-dropdown').classList.add('hidden');
      document.getElementById('rating-page').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closePage() {
      document.querySelectorAll('.full-page').forEach(p => p.classList.add('hidden'));
      document.body.style.overflow = 'auto';
    }

    document.addEventListener("click", function (event) {
      const profileArea = document.querySelector(".profile-section");
      const dropdown = document.getElementById("profile-dropdown");
      if (!profileArea.contains(event.target)) {
        dropdown.classList.add("hidden");
      }
    });

    function logout() {
      document.getElementById("profile-dropdown").classList.add("hidden");

      const overlay = document.createElement("div");
      overlay.id = "logout-overlay";
      overlay.className = "overlay";  // class عام للتصميم فقط

      overlay.innerHTML = `
    <div class="logout-modal">
      <div class="logout-content">
        <i class="fas fa-sign-out-alt logout-icon"></i>
        <h3>تسجيل الخروج</h3>
        <p>هل أنت متأكد؟</p>
        <div class="logout-buttons">
          <button onclick="confirmLogout()" class="confirm-logout-btn">نعم</button>
          <button onclick="cancelLogout()" class="cancel-logout-btn">إلغاء</button>
        </div>
      </div>
    </div>`;

      document.body.appendChild(overlay);
    }

    function confirmLogout() {
      localStorage.clear();

      const overlay = document.getElementById("logout-overlay");
      overlay.innerHTML = `
    <div class="logout-modal">
      <div class="logout-content success">
        <i class="fas fa-check-circle success-icon"></i>
        <h3>تم تسجيل الخروج</h3>
        <button onclick="closeLogoutSuccess()" class="success-btn">موافق</button>
      </div>
    </div>`;
    }

    function cancelLogout() {
      const overlay = document.getElementById("logout-overlay");
      if (overlay) overlay.remove();
    }

    function closeLogoutSuccess() {
      window.location.href = "login.html";
    }


    function showSwitchRoleConfirmation() {
      document.getElementById("switch-role-confirmation").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function confirmSwitchRole() {
      window.location.href = "passengerRides.html";
    }

    function cancelSwitchRole() {
      document.getElementById("switch-role-confirmation").classList.add("hidden");
      document.body.style.overflow = "auto";
    }

    function updateStats(pending, accepted, rejected) {
      document.getElementById("new-requests").textContent = pending;
      document.getElementById("accepted").textContent = accepted;
      document.getElementById("rejected").textContent = rejected;
    }

    function initStats() {
      const accepted = parseInt(localStorage.getItem("driverAcceptedCount")) || 0;
      const rejected = parseInt(localStorage.getItem("driverRejectedCount")) || 0;
      updateStats(0, accepted, rejected);
    }

    function loadDriverRides() {
      const driverEmail = localStorage.getItem("userEmail");

      fetch(`http://localhost:8083/api/rides/driver-rides?email=${driverEmail}`)
        .then(res => res.json())
        .then(rides => {

          console.log("رحلات السائق بعد التحديث:", rides); // هنا الصحيح

          const mainArea = document.getElementById("driver-rides-area");
          mainArea.innerHTML = "";


          rides.forEach(ride => {
            const rideCard = document.createElement("div");
            rideCard.className = "ride-details-card";
            rideCard.id = `ride-${ride.rideId}`;

            rideCard.style = `
            background:white;
            padding:20px;
            border-radius:15px;
            box-shadow:0 2px 5px rgba(0,0,0,0.1);
            margin-bottom:25px;
          `;

            rideCard.innerHTML = `
<div class="trip-card">

    <div class="card-header">
        <h3 class="card-title">رحلة منشورة</h3>
       <button class="delete-icon" onclick="cancelRide(${ride.rideId})">
    <i class="fas fa-trash"></i>
</button>
   </div>

    <div class="trip-info-grid">

        <div class="info-box">
            <i class="fas fa-map-marker-alt"></i>
            <div>
                <span class="label">نقطة الانطلاق:</span>
                <span class="value">${ride.currentLocation}</span>
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-flag"></i>
            <div>
                <span class="label">نقطة الوصول:</span>
                <span class="value">${ride.destination}</span>
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-calendar"></i>
            <div>
                <span class="label">اليوم:</span>
                <span class="value">${ride.date}</span>
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-clock"></i>
            <div>
                <span class="label">الوقت:</span>
                <span class="value">${ride.time}</span>
            </div>
        </div>

        <div class="info-box">
            <i class="fas fa-users"></i>
            <div>
                <span class="label">المقاعد المتبقية:</span>
                <span class="value">${ride.seatsAvailable}/${ride.totalSeats}</span>
            </div>
        </div>
            <button class="startRideBtn" onclick="startRide(${ride.rideId}, '${ride.destination}')">بدء الرحلة</button>

    </div>
<div class="passenger-box">

  <div class="passenger-header">
      <h3 class="sub-title">الركاب المنضمون</h3>
      <button class="chat-icon" onclick="openChat(${ride.rideId})">
          <i class="fas fa-comment"></i>
      </button>
  </div>

  <div id="passengers-${ride.rideId}" class="accepted-passengers"></div>
</div>
    <h3 class="sub-title">طلبات الحجز</h3>
    <div id="requests-${ride.rideId}" class="requests-container"></div>

</div>
`;



            mainArea.appendChild(rideCard);
            loadAcceptedPassengers(ride.rideId);

          });

          loadBookingRequests();
        });
    }

    function loadBookingRequests() {
      const driverEmail = localStorage.getItem("userEmail");

      fetch(`http://localhost:8083/api/bookings/driver-requests?driverEmail=${driverEmail}`)
        .then(res => res.json())
        .then(requests => {

          const pendingCount = requests.length;
          const accepted = parseInt(localStorage.getItem("driverAcceptedCount")) || 0;
          const rejected = parseInt(localStorage.getItem("driverRejectedCount")) || 0;

          updateStats(pendingCount, accepted, rejected);

          if (requests.length === 0) return;

          const grouped = {};
          requests.forEach(req => {
            const rId = req.ride.rideId;
            if (!grouped[rId]) grouped[rId] = [];
            grouped[rId].push(req);
          });

          Object.keys(grouped).forEach(rId => {
            const container = document.getElementById(`requests-${rId}`);
            if (!container) return;

            container.innerHTML = "";

            grouped[rId].forEach(req => {

              const card = document.createElement("div");
              card.className = "booking-request-card";
              card.id = `booking-${req.bookingId}`;
              card.className = "booking-request-card";
              card.style = `
              border:1px solid #ddd;
              padding:15px;
              border-radius:10px;
              background:white;
              display:flex;
              justify-content:space-between;
              align-items:center;
            `;

              card.innerHTML = `
              <div class="request-info" style="width:100%;">
                <h3 style="font-size:20px;color:#333;">طلب من: ${req.passenger.name}</h3>
                <p><b>موقع الانطلاق:</b> ${req.ride.currentLocation}</p>
              </div>

              <div class="request-actions" style="display:flex; gap:10px;">
                <button onclick="respondToBooking(${req.bookingId}, 'accepted')"
                  style="background:#28a745; color:white; padding:8px 15px; border-radius:5px;">
                  قبول
                </button>

                <button onclick="respondToBooking(${req.bookingId}, 'rejected')"
                  style="background:#dc3545; color:white; padding:8px 15px; border-radius:5px;">
                  رفض
                </button>
              </div>
            `;

              container.appendChild(card);
            });
          });

        });
    }

    function respondToBooking(bookingId, status) {
      fetch(`http://localhost:8083/api/bookings/respond?bookingId=${bookingId}&status=${status}`, {
        method: "POST"
      })
        .then(res => {
          if (!res.ok) {
            alert("فشل الرد على الطلب");
            return;
          }

          alert(status === "accepted" ? "تم قبول الحجز" : "تم رفض الحجز");

          let accepted = parseInt(localStorage.getItem("driverAcceptedCount")) || 0;
          let rejected = parseInt(localStorage.getItem("driverRejectedCount")) || 0;

          if (status === "accepted") {
            localStorage.setItem("driverAcceptedCount", ++accepted);
          } else {
            localStorage.setItem("driverRejectedCount", ++rejected);

            //  حذف كارد الراكب فقط إذا كان مرفوض
            const card = document.getElementById(`booking-${bookingId}`);
            if (card) card.remove();
          }

          // الاحتفاظ بتحميل طلبات القبول فقط
          if (status === "accepted") {
            loadDriverRides();
          }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      initStats();
      loadDriverRides();
    });

    function loadAcceptedPassengers(rideId) {
      fetch(`http://localhost:8083/api/bookings/accepted-passengers?rideId=${rideId}`)
        .then(res => res.json())
        .then(passengers => {
          const container = document.getElementById(`passengers-${rideId}`);
          container.innerHTML = "";

          if (passengers.length === 0) {
            container.innerHTML = "<p style='color:#777;font-size:14px;'>لا يوجد ركاب بعد</p>";
            return;
          }

          passengers.forEach(p => {
            const div = document.createElement("div");
            div.className = "accepted-passenger-card";
            div.innerHTML = `
          <p><i class="fas fa-user"></i> ${p.passengerName}
</p>
        `;
            container.appendChild(div);
          });
        });
    }

    function startRide(rideId, destination) {
      // ننتقل للصفحة مع تمرير المتغيرات في رابط URL
      window.location.href = `driverCurrentRide.html?rideId=${rideId}&destination=${encodeURIComponent(destination)}`;
    }



    function openChat(rideId) {
      // حفظ رقم الرحلة
      localStorage.setItem('currentRideId', rideId);
      localStorage.setItem('currentUserId', 'DRIVER_' + localStorage.getItem("userEmail"));
      // الانتقال لصفحة المحادثة
      window.location.href = 'chat.html';
    }

    function cancelRide(rideId) {
      if (!confirm("هل أنت متأكد من إلغاء الرحلة؟ سيتم إعلام الركاب.")) return;

      fetch(`http://localhost:8083/api/rides/${rideId}/cancel`, {
        method: "POST"
      })
        .then(res => {
          if (!res.ok) {
            alert("فشل إلغاء الرحلة");
            return;
          }

          alert("تم إلغاء الرحلة بنجاح");

          // حذف الكارد من الشاشة مباشرة
          const card = document.getElementById(`ride-${rideId}`);
          if (card) card.remove();

          // إرسال إشعار للركاب
          notifyPassengersRideCancelled(rideId);
        });
    }

    function notifyPassengersRideCancelled(rideId) {
      fetch(`http://localhost:8083/api/bookings/ride-cancelled?rideId=${rideId}`)
        .then(() => {
          console.log("تم إعلام الركاب!");
        });
    }


  </script>
  </div>
</body>

</html>