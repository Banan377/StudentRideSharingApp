<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <title>الرحلات السابقة</title>

  <link rel="stylesheet" href="driver.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>

  <!-- القائمة الجانبية -->
  <div class="sidebar">
    <div class="logo"></div>
    <ul class="menue">
      <li><a href="driverUI.html"><i class="fas fa-home"></i><span>الصفحة الرئيسية</span></a></li>
      <li><a href="driverRidesHistory.html"><i class="fas fa-history"></i><span>سجل الرحلات</span></a></li>
      <li><a href="#"><i class="fas fa-bell"></i><span>الإشعارات</span></a></li>
      <li><a href="driverEvents.html"><i class="fas fa-school"></i><span>أنشطة الجامعة</span></a></li>
    </ul>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="main-content">
    <div class="top-bar">
      <div style="display: flex; align-items: center; gap: 15px;">

        <!-- الملف الشخصي -->
        <div class="profile-section">
          <button onclick="toggleProfileDropdown()" class="profile-btn">
            <i class="fas fa-user-circle"></i>
          </button>

          <div id="profile-dropdown" class="dropdown-menu hidden">
            <ul>
              <li><a href="#" onclick="showRatingPage()"><i class="fas fa-star"></i><span>سجل التقييمات</span></a></li>
              <li><a href="driverSetting.html"><i class="fas fa-cog"></i><span>الإعدادات</span></a></li>
              <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>تسجيل الخروج</span></a></li>
            </ul>
          </div>
        </div>

      </div>
    </div>

    <!-- صفحة التقييمات -->
    <div id="rating-page" class="full-page hidden">
      <div class="container-form">
        <div class="form-box">
          <div class="page-header">
            <button onclick="closePage()" class="back-btn"><i class="fas fa-arrow-right"></i></button>
            <h2>سجل التقييمات</h2>
          </div>

          <div class="rating-history">
            <div class="rating-summary">
              <div class="average-rating">
                <span class="rating-number">0.0</span>
                <div class="stars-display">
                  <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                  <i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
                <span class="total-reviews">(0 تقييم)</span>
                <p>ستظهر تقييماتك هنا بعد إكمال الرحلات</p>
              </div>
            </div>

            <div class="reviews-list">
              <div class="no-reviews">
                <i class="fas fa-star-o"></i>
                <p>لا توجد تقييمات بعد</p>
                <span>ستظهر تقييمات الركاب هنا بعد إكمال الرحلات</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- قسم الرحلات السابقة -->
    <section class="trips-section">
      <div class="events-grid"></div>
    </section>

  </div> 

  <script>
    function toggleProfileDropdown() {
      document.getElementById('profile-dropdown').classList.toggle('hidden');
    }

    function showRatingPage() {
      document.getElementById('profile-dropdown').classList.add('hidden');
      document.getElementById('rating-page').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function logout() {
      document.getElementById('profile-dropdown').classList.add('hidden');
      const overlay = document.createElement('div');
      overlay.className = 'logout-overlay';
      overlay.id = 'logout-confirmation';

      overlay.innerHTML = `
        <div class="logout-modal">
          <div class="logout-content">
            <i class="fas fa-sign-out-alt logout-icon"></i>
            <h3>تسجيل الخروج</h3>
            <p>هل أنت متأكد؟</p>
            <div class="logout-buttons">
              <button onclick="confirmLogout()" class="confirm-logout-btn">نعم</button>
              <button onclick="cancelLogout()" class="cancel-logout-btn">إلغاء</button>
            </div>
          </div>
        </div>`;
      document.body.appendChild(overlay);
    }

    function confirmLogout() {
      localStorage.removeItem("currentUser");
      localStorage.removeItem("userEmail");
      localStorage.removeItem("resetPasswordMode");

      const overlay = document.getElementById('logout-confirmation');
      overlay.innerHTML = `
        <div class="logout-modal">
          <div class="logout-content success">
            <i class="fas fa-check-circle success-icon"></i>
            <h3>تم تسجيل الخروج</h3>
            <button onclick="closeLogoutSuccess()" class="success-btn">موافق</button>
          </div>
        </div>`;
    }

    function cancelLogout() {
      const overlay = document.getElementById('logout-confirmation');
      if (overlay) overlay.remove();
    }

    function closeLogoutSuccess() {
      window.location.href = "login.html";
    }

    document.addEventListener('click', function (event) {
      const profileSection = document.querySelector('.profile-section');
      if (!profileSection.contains(event.target)) {
        document.getElementById('profile-dropdown').classList.add('hidden');
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      const driverEmail = localStorage.getItem("userEmail");

      fetch(`http://localhost:8083/api/rides/driver-past?email=${driverEmail}`)
        .then(res => res.json())
        .then(rides => renderHistoryCards(rides));
    });

    function renderHistoryCards(rides) {
      const container = document.querySelector('.events-grid');
      container.innerHTML = "";

      if (!rides || rides.length === 0) {
        container.innerHTML = "<p style='text-align:center;color:#777;'>لا توجد رحلات سابقة</p>";
        return;
      }

      rides.forEach(ride => {
        const card = document.createElement("div");
        card.className = "trip-card";

        card.innerHTML = `
          <div class="card-header">
            <h3 class="card-title">رحلة سابقة</h3>
            <div class="chat-icon"><i class="fas fa-comment"></i></div>
          </div>

          <div class="trip-info-grid">
            <div class="info-box">
              <i class="fas fa-map-marker-alt"></i>
              <div>
                <span class="label">نقطة الانطلاق:</span>
                <span class="value">${ride.currentLocation}</span>
              </div>
            </div>

            <div class="info-box">
              <i class="fas fa-flag"></i>
              <div>
                <span class="label">نقطة الوصول:</span>
                <span class="value">${ride.destination}</span>
              </div>
            </div>

            <div class="info-box">
              <i class="fas fa-calendar"></i>
              <div>
                <span class="label">اليوم:</span>
                <span class="value">${ride.date}</span>
              </div>
            </div>

            <div class="info-box">
              <i class="fas fa-clock"></i>
              <div>
                <span class="label">الوقت:</span>
                <span class="value">${ride.time}</span>
              </div>
            </div>

            <div class="info-box">
              <i class="fas fa-users"></i>
              <div>
                <span class="label">المقاعد:</span>
                <span class="value">${ride.totalSeats}</span>
              </div>
            </div>
          </div>

          <h3 class="sub-title">طلبات إعادة الركوب</h3>
          <div class="requests-container" id="again-requests-${ride.rideId}"></div>
        `;

        container.appendChild(card);
        loadRepeatRequests(ride.rideId);
      });
    }

    function loadRepeatRequests(rideId) {
      fetch(`http://localhost:8083/api/ride-again/driver-requests?rideId=${rideId}`)
        .then(res => res.json())
        .then(requests => {
          const container = document.getElementById(`again-requests-${rideId}`);
          container.innerHTML = "";

          if (!requests || requests.length === 0) {
            container.innerHTML = "<p style='color:#777;'>لا توجد طلبات</p>";
            return;
          }

          requests.forEach(req => {
            const div = document.createElement("div");
            div.className = "again-request-card";

            div.innerHTML = `
              <div class="again-request-info">
                <p><b>من:</b> ${req.passenger.name}</p>
              </div>

              <div class="again-request-actions">
                <button onclick="respondRepeat(${req.bookingId}, 'accepted')" class="accept-btn">قبول</button>
                <button onclick="respondRepeat(${req.bookingId}, 'rejected')" class="reject-btn">رفض</button>
              </div>
            `;

            container.appendChild(div);
          });
        });
    }

    function respondRepeat(bookingId, status) {
      fetch(`http://localhost:8083/api/ride-again/respond?bookingId=${bookingId}&status=${status}`, {
        method: "POST"
      }).then(() => location.reload());
    }
  </script>

  <!-- تصميم الكارد -->
  <style>
    .top-bar {
    display: flex;
    justify-content: space-between !important;
    padding: 15px;
    align-items: center;
}

    .trip-card {
      background: white;
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      border: 1px solid #ebebeb;
      min-height: 320px;
      width: 100%;
      transition: 0.3s ease;
    }

    .trip-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }

    .card-title {
      font-size: 20px;
      font-weight: bold;
      color: #265262;
    }

    .trip-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    .info-box {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .info-box i {
      color: #487788;
      font-size: 18px;
    }

    .label {
      font-size: 12px;
      color: #666;
    }

    .value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }

    .sub-title {
      margin-top: 20px;
      font-size: 17px;
      font-weight: bold;
      color: #265262;
    }

    .again-request-card {
      border: 1px solid #ddd;
      background: white;
      padding: 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
    }

    .again-request-info {
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }

    .again-request-actions {
      display: flex;
      gap: 10px;
    }

    .accept-btn {
      background: #28a745;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .reject-btn {
      background: #dc3545;
      color: white;
      padding: 8px 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
  </style>

</body>

</html>
