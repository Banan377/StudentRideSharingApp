<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <title>ØµÙØ­Ø© Ø§Ù„Ø­Ø¬Ø²</title>
    <link rel="stylesheet" href="passenger.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>

    <div class="sidebar">
        <div class="logo"></div>
        <ul class="menue">
            <li><a href="passengerRides.html"><i class="fas fa-home"></i><span>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a></li>
            <li><a href="#"><i class="fas fa-history"></i><span>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span></a></li>
            <li><a href="#"><i class="fas fa-bell"></i><span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></a></li>
            <li><a href="#"><i class="fas fa-school"></i><span>Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</span></a></li>
        </ul>
    </div>

    <main class="main-content">

        <div class="container">
            <div class="header">
                <div class="search-box">
                    <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§" />
                    <i class="fas fa-search"></i>
                </div>

                <div class="profile-section">
                    <button onclick="toggleProfileDropdown()" class="profile-btn">
                        <i class="fas fa-user-circle"></i>
                    </button>

                    <div id="profile-dropdown" class="dropdown-menu hidden" aria-hidden="true">
                        <ul>
                            <li><a href="#" onclick="showRatingPage()"><i class="fas fa-star"></i><span>Ø³Ø¬Ù„
                                        Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span></a></li>
                            <li><a href="passengerSetting.html"><i class="fas fa-cog"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a>
                            </li>
                            <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>ØªØ³Ø¬ÙŠÙ„
                                        Ø§Ù„Ø®Ø±ÙˆØ¬</span></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
        <div id="rating-page" class="full-page hidden">
            <div class="container-form">
                <div class="form-box">
                    <div class="page-header">
                        <button onclick="closePage()" class="back-btn"><i class="fas fa-arrow-right"></i></button>
                        <h2>Ø³Ø¬Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
                    </div>
                    <div class="rating-history">
                        <div class="rating-summary">
                            <div class="average-rating">
                                <span class="rating-number">0.0</span>
                                <div class="stars-display">
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i><i class="fas fa-star"></i>
                                </div>
                                <span class="total-reviews">(0 ØªÙ‚ÙŠÙŠÙ…)</span>
                                <p>Ø³ØªØ¸Ù‡Ø± ØªÙ‚ÙŠÙŠÙ…Ø§ØªÙƒ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</p>
                            </div>
                        </div>
                        <div class="reviews-list">
                            <div class="no-reviews">
                                <i class="fas fa-star"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>
                                <span>Ø³ØªØ¸Ù‡Ø± ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø±ÙƒØ§Ø¨ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø­Ù„Ø§Øª -->
        <section class="trips-section">
            <div class="trips-grid">
                <!-- Ø§Ù„ÙƒØ±ÙˆØª ØªØ¬ÙŠ Ù…Ù† JavaScript -->
            </div>
        </section>

        <div id="driver-modal-root"></div>

        <script>
            // ====== Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ======
            function toggleProfileDropdown() {
                document.getElementById('profile-dropdown').classList.toggle('hidden');
            }

            function showRatingPage() {
                document.getElementById('profile-dropdown').classList.add('hidden');
                document.getElementById('rating-page').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closePage() {
                document.querySelectorAll('.full-page').forEach(p => p.classList.add('hidden'));
                document.body.style.overflow = 'auto';
            }

            function logout() {
                document.getElementById('profile-dropdown').classList.add('hidden');

                const overlay = document.createElement('div');
                overlay.className = 'logout-overlay';
                overlay.innerHTML = `
          <div class="logout-modal">
            <div class="logout-content">
              <i class="fas fa-sign-out-alt logout-icon"></i>
              <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
              <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ</p>
              <div class="logout-buttons">
                <button onclick="confirmLogout()" class="confirm-logout-btn">Ù†Ø¹Ù…</button>
                <button onclick="cancelLogout()" class="cancel-logout-btn">Ø¥Ù„ØºØ§Ø¡</button>
              </div>
            </div>
          </div>`;
                document.body.appendChild(overlay);
            }

            function confirmLogout() {
                localStorage.removeItem("currentUser");
                localStorage.removeItem("userEmail");
                localStorage.removeItem("resetPasswordMode");

                const overlay = document.querySelector('.logout-overlay');
                overlay.innerHTML = `
          <div class="logout-modal">
            <div class="logout-content success">
              <i class="fas fa-check-circle success-icon"></i>
              <h3>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h3>
              <button onclick="closeLogoutSuccess()" class="success-btn">Ù…ÙˆØ§ÙÙ‚</button>
            </div>
          </div>`;
            }

            function cancelLogout() {
                const overlay = document.querySelector('.logout-overlay');
                if (overlay) overlay.remove();
            }

            function closeLogoutSuccess() {
                const overlay = document.querySelector('.logout-overlay');
                if (overlay) overlay.remove();
                window.location.href = "login.html";
            }

            document.addEventListener('click', function (event) {
                const profileSection = document.querySelector('.profile-section');
                const dropdown = document.getElementById('profile-dropdown');
                if (!profileSection.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ======
            window.addEventListener("DOMContentLoaded", () => {
                loadAvailableRides();
            });

            function loadAvailableRides() {
               const passengerEmail = localStorage.getItem("userEmail");

fetch(`http://localhost:8083/api/rides/available?passengerEmail=${passengerEmail}`)


                    .then(res => res.json())
                    .then(data => {
                        const container = document.querySelector(".trips-grid");
                        if (!container) return;

                        container.innerHTML = ""; // Ø§Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ…

                        if (!Array.isArray(data) || data.length === 0) {
                            container.innerHTML = `<p style="padding:20px; text-align:center; color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
                            return;
                        }

                        data.forEach(ride => {
                            const card = document.createElement("article");
                            card.className = "trip-card";

                            card.innerHTML = `
                <div>
                  <div class="card-header">
                    <h3>Ø±Ø­Ù„Ø© Ù…ØªØ§Ø­Ø©</h3>
                    <div class="chat-icon"><i class="fas fa-comment"></i></div>
                  </div>
                  <div class="trip-info">
                    <div class="location-row">
                      <div class="location-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                          <span class="label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</span>
                          <span class="value">${ride.currentLocation || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                        </div>
                      </div>
                      <div class="location-item">
                        <i class="fas fa-flag"></i>
                        <div>
                          <span class="label">Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„:</span>
                          <span class="value">${ride.destination || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}</span>
                        </div>
                      </div>
                    </div>
                    <div class="details-row">
                      <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                          <span class="label">Ø§Ù„ÙŠÙˆÙ…:</span>
                          <span class="value">${ride.date || ''}</span>
                        </div>
                      </div>
                      <div class="detail-item">
                        <i class="fas fa-clock"></i>
                        <div>
                          <span class="label">Ø§Ù„ÙˆÙ‚Øª:</span>
                          <span class="value">${ride.time || ''}</span>
                        </div>
                      </div>
                      <div class="detail-item">
                        <i class="fas fa-users"></i>
                        <div>
                          <span class="label">Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</span>
                          <span class="value">${ride.seatsAvailable ?? ''}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="driver-section">
                  <div class="driver-info">
                    <div class="default-avatar driver-avatar"><i class="fas fa-user"></i></div>
                    <div class="driver-details">
                      <div class="driver-name">${ride.driverEmail || 'Ø³Ø§Ø¦Ù‚'}</div>
                    </div>
                  </div>
                  <button class="book-btn" data-ride-id="${ride.rideId}">Ø­Ø¬Ø²</button>
                </div>
              `;

                            container.appendChild(card);
                        });

                        // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø¬Ø² Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ±ÙˆØª
                        document.querySelectorAll(".book-btn").forEach(btn => {
                            btn.addEventListener("click", () => {
                                const rideId = btn.getAttribute("data-ride-id");
                                const card = btn.closest(".trip-card");
                                sendBookingRequest(rideId, card);
                            });
                        });
                    })
                    .catch(err => {
                        console.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø§Øª:", err);
                        // Ø¨Ø¯ÙˆÙ† alert Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ²Ø¹Ø¬Ùƒ
                    });
            }

            // ====== Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² ======
            function sendBookingRequest(rideId, cardElement) {
                const passengerEmail = localStorage.getItem("userEmail") || "passenger@example.com";

                // Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ Controller: /api/bookings/request?passengerEmail=&rideId=
                fetch(`http://localhost:8083/api/bookings/request?passengerEmail=${encodeURIComponent(passengerEmail)}&rideId=${rideId}`, {
                    method: "POST"
                })
                    .then(res => {
                        if (res.ok) {
                            alert("ğŸ‰ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ù„Ù„Ø³Ø§Ø¦Ù‚!");

                            // ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø±Ø¯ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø¬Ø²
                            if (cardElement) {
                                cardElement.remove();
                            }
                        } else {
                            alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø².");
                        }
                    })
                    .catch(err => {
                        console.error("Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø²:", err);
                    });
            }
        </script>

</body>

</html>
